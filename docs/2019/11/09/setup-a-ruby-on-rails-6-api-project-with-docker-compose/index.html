<!DOCTYPE html> <!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"><![endif]--> <!--[if IE 7]><html class="no-js lt-ie9 lt-ie8"><![endif]--> <!--[if IE 8]><html class="no-js lt-ie9"><![endif]--> <!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]--> <head> <meta charset="utf-8"> <!--[if IE]><meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'><![endif]--> <meta name="viewport" content="width=device-width,initial-scale=1"> <title>Setup a Ruby on Rails 6 API project with Docker Compose | Yi Zeng’s Blog</title> <meta name="generator" content="Jekyll v3.9.3"/> <meta property="og:title" content="Setup a Ruby on Rails 6 API project with Docker Compose"/> <meta name="author" content="Yi Zeng"/> <meta property="og:locale" content="en"/> <meta name="description" content="How to setup a Ruby on Rails 6 API project with Docker Compose."/> <meta property="og:description" content="How to setup a Ruby on Rails 6 API project with Docker Compose."/> <link rel="canonical" href="http://yizeng.me/2019/11/09/setup-a-ruby-on-rails-6-api-project-with-docker-compose/"/> <meta property="og:url" content="http://yizeng.me/2019/11/09/setup-a-ruby-on-rails-6-api-project-with-docker-compose/"/> <meta property="og:site_name" content="Yi Zeng’s Blog"/> <meta property="og:type" content="article"/> <meta property="article:published_time" content="2019-11-09T00:00:00+01:00"/> <meta name="twitter:card" content="summary"/> <meta property="twitter:title" content="Setup a Ruby on Rails 6 API project with Docker Compose"/> <script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Yi Zeng"},"dateModified":"2019-11-09T00:00:00+01:00","datePublished":"2019-11-09T00:00:00+01:00","description":"How to setup a Ruby on Rails 6 API project with Docker Compose.","headline":"Setup a Ruby on Rails 6 API project with Docker Compose","mainEntityOfPage":{"@type":"WebPage","@id":"http://yizeng.me/2019/11/09/setup-a-ruby-on-rails-6-api-project-with-docker-compose/"},"url":"http://yizeng.me/2019/11/09/setup-a-ruby-on-rails-6-api-project-with-docker-compose/"}</script> <meta name="keywords" content="api,docker,ruby on rails"/> <link type="application/atom+xml" rel="alternate" href="http://yizeng.me/feed.xml" title="Yi Zeng’s Blog"/> <link href='/assets/stylesheets/blog.css' rel="stylesheet" type="text/css"> <script src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script> <script>window.Modernizr||document.write('<script src="/assets/javascripts/modernizr-2.8.3.min.js"><\/script>');</script> <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script> <script>window.jQuery||document.write('<script src="/assets/javascripts/jquery-3.3.1.min.js"><\/script>');</script> <script src="//cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/pace.min.js"></script> <script>window.Pace||document.write('<script src="/assets/javascripts/pace.min.js"><\/script>');</script> <script>(function(b,m,h,a,g){b[a]=b[a]||[];b[a].push({"gtm.start":new Date().getTime(),event:"gtm.js"});var k=m.getElementsByTagName(h)[0],e=m.createElement(h),c=a!="dataLayer"?"&l="+a:"";e.async=true;e.src="https://www.googletagmanager.com/gtm.js?id="+g+c;k.parentNode.insertBefore(e,k)})(window,document,"script","dataLayer","GTM-P5NFP45");</script> </head> <body> <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-P5NFP45" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript> <!--[if IE]><p class="site-notice">You are using an outdated browser. Please <a href="http://browsehappy.com/" target="_blank">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true" target="_blank">activate Google Chrome Frame</a> to improve your experience.</p><![endif]--> <noscript> <p class="site-notice">This site requires JavaScript. Here are the instructions <a href="http://www.enable-javascript.com/" target="_blank">how to enable JavaScript in your web browser</a>.</p> </noscript> <div class="nav-wrapper overlay-wrapper"> <div class="nav-form overlay-form"> <span class="overlay-header menu">Menu</span> <a class="btn-close">Close</a> <div class="results"> <ul> <li><a href="/blog/categories/">Categories</a></li> <li><a href="/blog/tags/">Tags</a></li> <li><a href="/">About</a></li> </ul> </div> </div> </div> <div class="search-wrapper overlay-wrapper"> <div class="search-form overlay-form"> <input type="text" class="overlay-header search-field" placeholder="Search..."> <a class="btn-close">Close</a> <ul class="results"></ul> </div> </div> <div id="page" class="hentry"> <header class="the-header"> <div class="unit-head"> <div class="unit-inner unit-head-inner"> <nav class="nav-global"> <ul> <li class="logo nav-link"> <button class="btn-menu" title="Menu"></button> <a href="/blog/">Yi Zeng’s Blog</a> <!--[if !IE]>--> <button class="btn-search" title="Search"></button> <!--<![endif]--> </li> <li class="nav-link"><a title="Categories" href="/blog/categories/">Categories</a></li> <li class="nav-link"><a title="Tags" href="/blog/tags/">Tags</a></li> <!--[if !IE]>--> <li class="nav-link"><a title="Search" class="btn-search" href="#">Search</a></li> <!--<![endif]--> </ul> </nav> </div> </div> </header> <div class="body animated fadeInDown" role="main"> <div class="unit-body"> <div class="unit-inner unit-body-inner"> <div class="entry-content"> <article class="unit-article layout-post"> <div class="unit-inner unit-article-inner"> <div itemscope itemtype="http://schema.org/Article" class="content"> <header> <div class="unit-head"> <div class="unit-inner unit-head-inner"> <h1 class="entry-title" itemprop="name">Setup a Ruby on Rails 6 API project with Docker Compose</h1> </div> </div> </header> <div class="bd article-content"> <div class="entry-content"> <div class="meta"> <p class="date-publish"> Published: <time itemprop="datePublished" class="date-pub updated" title="2019-11-09T00:00:00+01:00" datetime="2019-11-09T00:00:00+01:00">November 09, 2019 </time> by <a class="author" href="/" rel="author" title="Show Author"> <span itemprop="author" itemscope itemtype="http://schema.org/Person"> <span itemprop="name">Yi Zeng</span> </span> </a> <a class="license-icon" rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank" title="Show License"> <img alt="Creative Commons Licence" style="border-width:0" src="/assets/images/theme/cc-by-sa.png" height="16" width="80"/> </a> </p> <ul class="list-category list-linear"> <li class="list-head">Categories: </li> <li> <a href="/blog/categories/#tutorials" title="tutorials"> tutorials <span>26</span></a> </li> </ul> <ul class="list-tag list-linear"> <li class="list-head">Tags: </li> <li> <a href="/blog/tags/#api" title="api">api <span>4</span></a> </li> <li> <a href="/blog/tags/#docker" title="docker">docker <span>4</span></a> </li> <li> <a href="/blog/tags/#ruby-on-rails" title="ruby on rails">ruby on rails <span>10</span></a> </li> </ul> </div> <div itemprop="articleBody"> <p>Here is a quick rundown on how to setup a Ruby on Rails 6 API project with Docker Compose.</p> <ul class="toc" id="markdown-toc"> <li><a href="#heading-prerequisites" id="markdown-toc-heading-prerequisites">Prerequisites</a> <ul> <li><a href="#heading-docker-and-docker-compose" id="markdown-toc-heading-docker-and-docker-compose">Docker and Docker Compose</a></li> <li><a href="#heading-ruby" id="markdown-toc-heading-ruby">Ruby</a></li> </ul> </li> <li><a href="#heading-create-a-rails-6-api-project" id="markdown-toc-heading-create-a-rails-6-api-project">Create a Rails 6 API project</a></li> <li><a href="#heading-setup-docker" id="markdown-toc-heading-setup-docker">Setup Docker</a> <ul> <li><a href="#heading-create-dockerignore" id="markdown-toc-heading-create-dockerignore">Create .dockerignore</a></li> <li><a href="#heading-create-dockerfile" id="markdown-toc-heading-create-dockerfile">Create Dockerfile</a></li> </ul> </li> <li><a href="#heading-setup-docker-compose" id="markdown-toc-heading-setup-docker-compose">Setup Docker Compose</a> <ul> <li><a href="#heading-create-docker-composeyml" id="markdown-toc-heading-create-docker-composeyml">Create docker-compose.yml</a></li> <li><a href="#heading-config-databaseyml" id="markdown-toc-heading-config-databaseyml">Config database.yml</a></li> </ul> </li> <li><a href="#heading-start-rails-server" id="markdown-toc-heading-start-rails-server">Start Rails Server</a></li> <li><a href="#heading-install-rspec-optional" id="markdown-toc-heading-install-rspec-optional">Install RSpec (Optional)</a></li> <li><a href="#heading-troubleshooting" id="markdown-toc-heading-troubleshooting">Troubleshooting</a></li> </ul> <h2 id="heading-prerequisites">Prerequisites</h2> <h3 id="heading-docker-and-docker-compose">Docker and Docker Compose</h3> <p>Docker: <a href="https://www.docker.com/get-started" target="_blank">https://www.docker.com/get-started</a></p> <p>Docker Compose: <a href="https://docs.docker.com/compose/install" target="_blank">https://docs.docker.com/compose/install/</a></p> <p>For example, I have:</p> <blockquote> <p>$ docker -v<br/> $ Docker version 19.03.2, build 6a30dfc</p> <p>$ docker-compose -v<br/> $ docker-compose version 1.24.1, build 4667896b</p> </blockquote> <h3 id="heading-ruby">Ruby</h3> <p>Rails 6 requires Ruby 2.5.0 or newer<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>.</p> <p>If the local machine hasn't got Ruby installed, <a href="https://rvm.io/" target="_blank">RVM</a> would be a common solution to consider.</p> <p>For installing RVM with default Ruby and Rails in one command, run:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="se">\c</span>url <span class="nt">-sSL</span> https://get.rvm.io | bash <span class="nt">-s</span> stable <span class="nt">--rails</span>
</code></pre></div></div> <p>To verify the successful installation:</p> <blockquote> <p>$ ruby -v<br/> $ ruby 2.6.5p114 (2019-10-01 revision 67812) [x86_64-darwin18]</p> <p>$ rails -v<br/> $ Rails 6.0.2.1</p> </blockquote> <h2 id="heading-create-a-rails-6-api-project">Create a Rails 6 API project</h2> <p>To create a new Ruby on Rails 6 API project, run:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rails new rails-6-api-docker-demo <span class="nt">--api</span> <span class="nt">--database</span><span class="o">=</span>postgresql <span class="nt">-T</span> <span class="nt">-C</span>
</code></pre></div></div> <ul> <li><code class="language-plaintext highlighter-rouge">rails-6-api-docker-demo</code>: The name of the new project.</li> <li><code class="language-plaintext highlighter-rouge">--api</code>: Create an API only project.</li> <li><code class="language-plaintext highlighter-rouge">--database=postgresql</code>: Use <a href="https://www.postgresql.org/" target="_blank">PostgresQL</a> as the default database adapter.</li> <li><code class="language-plaintext highlighter-rouge">-T</code>: (Optional) Skip test files. <a href="https://rspec.info/" target="_blank">RSpec</a> would be a more common option.</li> <li><code class="language-plaintext highlighter-rouge">-C</code>: (Optional) Skip ActionCable if no WebSockets is needed for the project.</li> </ul> <h2 id="heading-setup-docker">Setup Docker</h2> <h3 id="heading-create-dockerignore">Create .dockerignore</h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>rails-6-api-docker-demo
<span class="nb">touch</span> .dockerignore
</code></pre></div></div> <p><a href="https://docs.docker.com/engine/reference/builder/#dockerignore-file" target="_blank"><code class="language-plaintext highlighter-rouge">.dockerignore</code></a> files essentially works the same way as <code class="language-plaintext highlighter-rouge">.gitignore</code>, but for docker containers. You may just use the content from <code class="language-plaintext highlighter-rouge">.gitignore</code> file plus the <code class="language-plaintext highlighter-rouge">.git</code> folder and <code class="language-plaintext highlighter-rouge">.gitignore</code> itself.</p> <p><a href="https://www.gitignore.io/" target="_blank">gitignore.io</a> can be handy for generating the desired <code class="language-plaintext highlighter-rouge">.gitignore</code> file. For example, <a href="https://www.gitignore.io/api/git,rails,rubymine" target="_blank">https://www.gitignore.io/api/git,rails,rubymine</a> gives an example of <code class="language-plaintext highlighter-rouge">.gitignore</code> file for git, rails and rubymine IDE.</p> <p><strong>Here's a complete example</strong>: <a href="https://gist.github.com/yizeng/eeeb48d6823801061791cc5581f7e1fc" target="_blank">https://gist.github.com/yizeng/eeeb48d6823801061791cc5581f7e1fc</a></p> <h3 id="heading-create-dockerfile">Create Dockerfile</h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">touch </span>Dockerfile
</code></pre></div></div> <p>A Dockerfile is a text document that contains all the commands a user could call on the command line to assemble an image. Using docker build users can create an automated build that executes several command-line instructions in succession.</p> <p>Full documentation can be found <a href="https://docs.docker.com/engine/reference/builder/" target="_blank">here</a>.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM ruby:alpine

RUN apk update <span class="o">&amp;&amp;</span> apk add bash build-base nodejs postgresql-dev tzdata

RUN <span class="nb">mkdir</span> /project
WORKDIR /project

COPY Gemfile Gemfile.lock ./
RUN gem <span class="nb">install </span>bundler <span class="nt">--no-document</span>
RUN bundle <span class="nb">install</span> <span class="nt">--no-binstubs</span> <span class="nt">--jobs</span> <span class="si">$(</span><span class="nb">nproc</span><span class="si">)</span> <span class="nt">--retry</span> 3

COPY <span class="nb">.</span> <span class="nb">.</span>

CMD <span class="o">[</span><span class="s2">"bundle"</span>, <span class="s2">"exec"</span>, <span class="s2">"rails"</span>, <span class="s2">"server"</span>, <span class="s2">"-b"</span>, <span class="s2">"0.0.0.0"</span><span class="o">]</span>
</code></pre></div></div> <ul> <li><code class="language-plaintext highlighter-rouge">FROM ruby:alpine</code>: Select the base image to build from. Here uses the latest alpine version of Ruby. Note that the version needs to match the Ruby version in <code class="language-plaintext highlighter-rouge">Gemfile</code>. If there is a mismatch (e.g. <code class="language-plaintext highlighter-rouge">ruby '2.6.5'</code> in <code class="language-plaintext highlighter-rouge">Gemfile</code>), then here would be <code class="language-plaintext highlighter-rouge">FROM ruby:2.6.5-alpine</code>. More versions can be found at the <a href="https://hub.docker.com/_/ruby" target="_blank">Docker Hub</a>.</li> <li><code class="language-plaintext highlighter-rouge">RUN apk update &amp;&amp; apk add build-base nodejs postgresql-dev tzdata</code>: Install the required packages inside Docker.</li> <li><code class="language-plaintext highlighter-rouge">RUN mkdir /project</code>: Create a folder called <code class="language-plaintext highlighter-rouge">project</code> to host the codebase.</li> <li><code class="language-plaintext highlighter-rouge">WORKDIR /project</code>: Set the working directory to <code class="language-plaintext highlighter-rouge">project</code> folder.</li> <li><code class="language-plaintext highlighter-rouge">COPY Gemfile Gemfile.lock ./</code>: Copy the files to the working directory.</li> <li><code class="language-plaintext highlighter-rouge">RUN gem install bundler</code>: Install the bundler gem. It needs to match the version in <code class="language-plaintext highlighter-rouge">Gemfile.lock</code>, A specific version can be set like <code class="language-plaintext highlighter-rouge">RUN gem install bundler -v 2.0.2</code>.</li> <li><code class="language-plaintext highlighter-rouge">COPY . .</code>: Copy the codebase into Docker.</li> <li><code class="language-plaintext highlighter-rouge">CMD ["bundle", "exec", "rails", "server", "-b", "0.0.0.0"]</code>: Set the start command.</li> </ul> <h2 id="heading-setup-docker-compose">Setup Docker Compose</h2> <h3 id="heading-create-docker-composeyml">Create docker-compose.yml</h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">touch </span>docker-compose.yml
</code></pre></div></div> <p>Docker compose is a tool to build a multi-container application, where <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> is the YAML config file that tells Docker Compose how to build the containers together.</p> <p>A more detailed documentation can be found <a href="https://docs.docker.com/compose/compose-file/" target="_blank">here</a>.</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3'</span>

<span class="na">services</span><span class="pi">:</span>
  <span class="na">db</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s1">'</span><span class="s">postgres:10-alpine'</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s1">'</span><span class="s">postgres:/var/lib/postgresql/data'</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s1">'</span><span class="s">5432:5432'</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">POSTGRES_HOST_AUTH_METHOD=trust</span>

  <span class="na">redis</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s1">'</span><span class="s">redis:5-alpine'</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s">redis-server</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s1">'</span><span class="s">6379:6379'</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s1">'</span><span class="s">redis:/data'</span>

  <span class="na">web</span><span class="pi">:</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s1">'</span><span class="s">db'</span>
      <span class="pi">-</span> <span class="s1">'</span><span class="s">redis'</span>
    <span class="na">build</span><span class="pi">:</span> <span class="s">.</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s">bash -c "rm -f tmp/pids/server.pid &amp;&amp; bundle exec rails s -p 3000 -b '0.0.0.0'"</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s1">'</span><span class="s">3000:3000'</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">DATABASE_HOST=db</span>

<span class="na">volumes</span><span class="pi">:</span>
  <span class="na">redis</span><span class="pi">:</span>
  <span class="na">postgres</span><span class="pi">:</span>
</code></pre></div></div> <p>Here defines 3 services in order to run the Rails application:</p> <ul> <li><code class="language-plaintext highlighter-rouge">db</code>: The PostgreSQL database service, which uses <code class="language-plaintext highlighter-rouge">postgres:10-alpine</code> here for example. It maps port 5432 inside Docker to the same port on local host machine.</li> <li><code class="language-plaintext highlighter-rouge">redis</code>: The Redis caching service, which uses <code class="language-plaintext highlighter-rouge">redis:5-alpine</code> here for example. It maps port 6379 inside Docker to the same port on local host machine. This is needed if Sidekiq is used for job processing or Rails caching is set to Redis instead of memcache.</li> <li><code class="language-plaintext highlighter-rouge">web</code>: This is how the Rails API is composed. It depends on <code class="language-plaintext highlighter-rouge">db</code> and <code class="language-plaintext highlighter-rouge">redis</code> with port 3000 exposed on host machine.</li> </ul> <h3 id="heading-config-databaseyml">Config database.yml</h3> <p>The default Ruby on Rails' <code class="language-plaintext highlighter-rouge">database.yml</code> needs to be configed with the Docker database URL by adding <code class="language-plaintext highlighter-rouge">host</code>, <code class="language-plaintext highlighter-rouge">username</code> and <code class="language-plaintext highlighter-rouge">password</code> to it.</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">default</span><span class="pi">:</span> <span class="nl">&amp;default</span>
  <span class="na">adapter</span><span class="pi">:</span> <span class="s">postgresql</span>
  <span class="na">encoding</span><span class="pi">:</span> <span class="s">unicode</span>
  <span class="na">pool</span><span class="pi">:</span> <span class="s">&lt;%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %&gt;</span>
  <span class="na">host</span><span class="pi">:</span> <span class="s">&lt;%= ENV.fetch("DATABASE_HOST") { "localhost" } %&gt;</span>
  <span class="na">port</span><span class="pi">:</span> <span class="s">&lt;%= ENV.fetch("DATABASE_PORT") { 5432 } %&gt;</span>
  <span class="na">username</span><span class="pi">:</span> <span class="s">&lt;%= ENV.fetch("DATABASE_USERNAME") { "postgres" } %&gt;</span>
  <span class="na">password</span><span class="pi">:</span> <span class="s">&lt;%= ENV.fetch("DATABASE_PASSWORD") { "" } %&gt;</span>

<span class="na">development</span><span class="pi">:</span>
  <span class="s">&lt;&lt;</span><span class="pi">:</span> <span class="nv">*default</span>
  <span class="na">database</span><span class="pi">:</span> <span class="s">rails_6_api_docker_demo_development</span>

<span class="na">test</span><span class="pi">:</span>
  <span class="s">&lt;&lt;</span><span class="pi">:</span> <span class="nv">*default</span>
  <span class="na">database</span><span class="pi">:</span> <span class="s">rails_6_api_docker_demo_test</span>

<span class="na">production</span><span class="pi">:</span>
  <span class="s">&lt;&lt;</span><span class="pi">:</span> <span class="nv">*default</span>
  <span class="na">database</span><span class="pi">:</span> <span class="s">rails_6_api_docker_demo_production</span>
  <span class="na">username</span><span class="pi">:</span> <span class="s">&lt;%= ENV.fetch("DATABASE_USERNAME") { "rails_6_api_docker_demo" } %&gt;</span>
  <span class="na">password</span><span class="pi">:</span> <span class="s">&lt;%= ENV.fetch("DATABASE_PASSWORD") { "" } %&gt;</span>
</code></pre></div></div> <h2 id="heading-start-rails-server">Start Rails Server</h2> <p>Build the containers</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose build
</code></pre></div></div> <p>Before starting the server, Rails databases need to be created first.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose run web bundle <span class="nb">exec </span>rails db:create
docker-compose run web bundle <span class="nb">exec </span>rails db:migrate
</code></pre></div></div> <p>Finally, to build and spin up the Rails 6 API server:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose up <span class="nt">--build</span>
</code></pre></div></div> <p>Head over to <a href="http://localhost:3000" target="_blank">http://localhost:3000</a> to test it out and start building the real API!</p> <h2 id="heading-install-rspec-optional">Install RSpec (Optional)</h2> <p>If the project was initialized with <code class="language-plaintext highlighter-rouge">-T</code> option that no tests are generated, a testing framework would be needed for the project.</p> <p>Here is how to add <a href="https://rspec.info/" target="_blank">RSpec</a> support.</p> <ol> <li> <p>Add rspec-rails to Gemfile</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Add it inside group :development, :test</span>
<span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="c1"># some existing gems...</span>
  <span class="c1"># ...</span>

  <span class="n">gem</span> <span class="s1">'rspec-rails'</span>
<span class="k">end</span>
</code></pre></div> </div> </li> <li> <p>Rebuild the containers</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose build
</code></pre></div> </div> </li> <li> <p>Install RSpec</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose run web bundle <span class="nb">exec </span>rails generate rspec:install
</code></pre></div> </div> </li> <li> <p>Run the tests</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose run web bundle <span class="nb">exec </span>rspec
</code></pre></div> </div> </li> </ol> <h2 id="heading-troubleshooting">Troubleshooting</h2> <blockquote> <p>Error starting userland proxy: listen tcp 0.0.0.0:6379: bind: address already in use</p> </blockquote> <ul> <li> <p><strong>Reason</strong>: Port 6379 is already in use on local machine.This is most likely that there is another Redis server running locally.</p> </li> <li> <p><strong>Solution</strong>: Either stop the Redis on local machine or map to another port in <code class="language-plaintext highlighter-rouge">docker-compose.yml</code>, like <code class="language-plaintext highlighter-rouge">- '6380:6379'</code>.</p> </li> </ul> <blockquote> <p>Error starting userland proxy: listen tcp 0.0.0.0:5432: bind: address already in use</p> </blockquote> <ul> <li> <p><strong>Reason</strong>: Port 5432 is already in use on local machine. This is most likely that there is another PostgreSQL server running locally.</p> </li> <li> <p><strong>Solution</strong>: Either stop the PostgreSQL on local machine or map to another port in <code class="language-plaintext highlighter-rouge">docker-compose.yml</code>, like <code class="language-plaintext highlighter-rouge">- '5434:5432'</code>.</p> </li> </ul> <blockquote> <p>Your Ruby version is 2.6.5, but your Gemfile specified 2.6.3<br/> ERROR: Service 'web' failed to build: The command '/bin/sh -c bundle install' returned a non-zero code: 18</p> </blockquote> <ul> <li> <p><strong>Reason</strong>: There is a Ruby version mismatch between <code class="language-plaintext highlighter-rouge">Gemfile</code> and Docker container.</p> </li> <li> <p><strong>Solution</strong>: Either update the Ruby version in <code class="language-plaintext highlighter-rouge">Gemfile</code> to <code class="language-plaintext highlighter-rouge">2.6.5</code>, or pull explicitly Ruby <code class="language-plaintext highlighter-rouge">2.6.3</code> image in <code class="language-plaintext highlighter-rouge">Dockerfile</code> like <code class="language-plaintext highlighter-rouge">FROM ruby:2.6.3-alpine</code>.</p> </li> </ul> <blockquote> <p>/usr/local/bundle/ruby/2.6.0/gems/activesupport-6.0.2.1/lib/active_support/railtie.rb:39:in<br/> rescue in block in &lt;class:Railtie&gt;': tzinfo-data is not present.<br/> Please add gem 'tzinfo-data' to your Gemfile and run bundle install (TZInfo::DataSourceNotFound)<br/> /usr/local/bundle/ruby/2.6.0/gems/tzinfo-1.2.5/lib/tzinfo/zoneinfo_data_source.rb:180:in `initialize':<br/> None of the paths included in TZInfo::ZoneinfoDataSource.search_path are valid zoneinfo directories. (TZInfo::ZoneinfoDirectoryNotFound)</p> </blockquote> <ul> <li> <p><strong>Reason</strong>: Required <code class="language-plaintext highlighter-rouge">tzdata</code> package was not installed in Docker container.</p> </li> <li> <p><strong>Solution</strong>: Include <code class="language-plaintext highlighter-rouge">tzdata</code> in <code class="language-plaintext highlighter-rouge">Dockerfile</code>'s <code class="language-plaintext highlighter-rouge">RUN apk add</code> command (see details above).</p> </li> </ul> <blockquote> <p>/usr/local/lib/ruby/2.6.0/rubygems.rb:283:in `find_spec_for_exe':<br/> Could not find 'bundler' (2.0.2) required by your /project/Gemfile.lock. (Gem::GemNotFoundException)<br/> ERROR: Service 'web' failed to build: The command '/bin/sh -c bundle install' returned a non-zero code: 1</p> </blockquote> <ul> <li> <p><strong>Reason</strong>: Required gem bundler was not installed in Docker container.</p> </li> <li> <p><strong>Solution</strong>: Include <code class="language-plaintext highlighter-rouge">RUN gem install bundler</code> command in <code class="language-plaintext highlighter-rouge">Dockerfile</code> (see details above).</p> </li> </ul> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:1" role="doc-endnote"> <p>https://edgeguides.rubyonrails.org/upgrading_ruby_on_rails.html#ruby-versions <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> </ol> </div> </div> </div> </div> <footer class="unit-foot"> <div class="unit-inner unit-foot-inner"> <div class="post-buttons"> <a class="internal gotop" href="#page" title="Back to Top">Back to Top</a> <div class="addthis_toolbox addthis_default_style addthis_32x32_style"> <small class="label">Share Post:</small> <a class="btn-share-post addthis_button_email"></a> <a class="btn-share-post addthis_button_facebook"></a> <a class="btn-share-post addthis_button_google_plusone_share"></a> <a class="btn-share-post addthis_button_reddit"></a> <a class="btn-share-post addthis_button_twitter"></a> </div> <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-53819e27689934f9"></script> </div> <nav class="pagination"> <a class="internal" rel="prev" href="/2017/07/16/generate-rails-test-fixtures-yaml-from-database-dump/" title=" 'Generate Rails test fixtures yaml from database dump'"> ← Generate Rails test fixtures yaml from database dump</a> <a class="internal" rel="next" href="/2019/11/12/load-environment-variables-with-docker-compose/" title="Next Post 'Load environment variables with Docker Compose'">Load environment variables with Docker Compose → </a> </nav> </div> </footer> <div class="misc-content"> <script>$(document).ready(function(){var b="ULZ0b9TFdfCUJSKQd4WCKv2v3u25YoG7YG8zXPewkWrT35lZ0Se9YnxLzoV6VM8W";var c="yizeng";var a="link:"+$(".comments .show-hidden").attr("data-disqus-url");$.ajax({type:"GET",url:"//disqus.com/api/3.0/threads/set.jsonp",data:{api_key:b,forum:c,thread:a},cache:false,dataType:"jsonp",success:function(d){if(d.response.length===1){btnText="Show Comments ("+d.response[0].posts+")";$(".comments .show-hidden").html(btnText)}}});$(".comments .show-hidden").on("click",function(){$.ajaxSetup({cache:true});$.getScript("//"+c+".disqus.com/embed.js");$.ajaxSetup({cache:false});$(this).remove()});if(/\#comments/.test(location.hash)){$(".comments .show-hidden").trigger("click")}});</script> <div class="comments"> <button class="center-block show-hidden" title="Show Comments" data-disqus-url="http://yizeng.me/2019/11/09/setup-a-ruby-on-rails-6-api-project-with-docker-compose/">Show Comments</button> <div id="disqus_thread"></div> </div> </div> </div> </div> </article> </div> </div> </div> </div> <footer class="the-footer"> <div class="unit-foot"> <div class="unit-inner unit-foot-inner"> <div class="misc vcard"> <div class="about"> <h4><a href="/">About</a></h4> <p>Yi Zeng, a senior software engineer based in Berlin, Germany.</p> <p><small>Theme <a href="https://github.com/yizeng/jekyll-theme-simple-texture" target="_blank">Simple Texture</a> developed by <a href="http://yizeng.me" target="_blank">Yi Zeng</a>, powered by <a href="https://jekyllrb.com/" target="_blank">Jekyll</a>.</small></p> </div> <div class="social-links"> <a class="ico-rss" href="/feed.xml" rel="me" target="_blank" title="feed"></a> <a class="ico-github" href="https://github.com/yizeng/" rel="me" target="_blank" title="github"></a> <a class="ico-linkedin" href="https://www.linkedin.com/in/yizengnz/" rel="me" target="_blank" title="linkedin"></a> <a class="ico-stackoverflow" href="https://stackoverflow.com/users/1177636/yi-zeng" rel="me" target="_blank" title="stackoverflow"></a> </div> </div> </div> </div> <a href="#" class="internal back-to-top">Back to Top</a> </footer> </div> <script>$(document).ready(function(){var c=50,b=500,a=960;$(window).scroll(function(){if($(window).width()>a){if($(this).scrollTop()>c){$("footer").css("top","20px");$("footer .back-to-top").fadeIn(b)}else{$("footer").css("top","auto");$("footer .back-to-top").fadeOut(b)}}});$(window).resize(function(){if($(window).width()<a){$("footer").css("top","auto");$("footer .back-to-top").fadeOut(b)}if($(window).width()>=a&&$(this).scrollTop()>c){$("footer").css("top","20px");$("footer .back-to-top").fadeIn(b)}});$("footer .back-to-top, .gotop").on("click",function(d){d.preventDefault();$("html, body").animate({scrollTop:0},b);return false});$(".show-hidden").on("click",function(){$(this).parent().next().toggleClass("hidden");$(this).toggleClass("hidden")})});</script> <script src="/assets/javascripts/jekyll-search.jquery.js"></script> <script>$(document).ready(function(){$(".search-field").simpleJekyllSearch({jsonFile:"/search.json",template:'<li><a href="{url}">{title} <span class="entry-date"><time datetime="{date}">{shortdate}</time></span></a></li>',searchResults:".search-wrapper .results",searchResultsTitle:"<h4>Search results</h4>",noResults:"<p>Oh shucks<br/><small>Nothing found :(</small></p>"})});(function(c,b,d){var a=function(){c(".nav-wrapper, .search-wrapper").removeAttr("style");c(".nav-form, .search-form").removeClass("active");c("body").removeClass("nav-overlay search-overlay")};c(".nav-global .btn-search").on("click",function(){c(".search-wrapper").css({display:"block"});c(".search-form").addClass("active");c(".search-form").find("input").focus();c("body").addClass("search-overlay")});c(".nav-global .btn-menu").on("click",function(){c(".nav-wrapper").css({display:"block"});c(".nav-form").addClass("active");c(".nav-form .search-field").prop("disabled",true);c("body").addClass("nav-overlay")});c(".nav-wrapper .btn-close, .search-wrapper .btn-close").on("click",function(){a()});c(document).on("keyup",function(f){if(f.keyCode===27){a()}})})(jQuery,window);</script> <script src='//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.js'></script> <script src='//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-buttons.min.js'></script> <script src="/assets/javascripts/unveil/jquery.unveil.min.js"></script> <script>window.jQuery.fancybox||document.write('<script src="/assets/javascripts/fancybox/jquery.fancybox.pack.js?v=2.1.4"><\/script>');window.jQuery.fancybox.helpers.buttons||document.write('<script src="/assets/javascripts/fancybox/helpers/jquery.fancybox-buttons.js?v=1.0.5"><\/script>');</script> <script>$("head").append('<link rel="stylesheet" href="/assets/javascripts/fancybox/jquery.fancybox.css?v=2.1.4" type="text/css" />');$("head").append('<link rel="stylesheet" href="/assets/javascripts/fancybox/helpers/jquery.fancybox-buttons.css?v=1.0.5" type="text/css" />');$(".post-image").fancybox({prevEffect:"none",nextEffect:"none",closeBtn:true,helpers:{title:{type:"float"}}});$(document).ready(function(){$(".post-image > img").unveil(450)});</script> </body> </html>